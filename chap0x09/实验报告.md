
# å…¥ä¾µæ£€æµ‹

## å®éªŒè¦æ±‚

- åˆ©ç”¨snortä»¥åŠsuricataå®ç°å…¥ä¾µæ£€æµ‹

## å®éªŒç¯å¢ƒ

- Snort  2.9.7.0 

- suricata 5.0.0

![](./img/ip.PNG)

#### **ç½‘ç»œæ‹“æ‰‘**

![](./img/æ‹“æ‰‘.PNG)

**ç½‘ç»œè¿é€šæ€§æµ‹è¯•**



![](./img/è¿é€šæ€§æµ‹è¯•.PNG)

## å®éªŒç¯å¢ƒé…ç½®

```bash
# ç¦æ­¢åœ¨aptå®‰è£…æ—¶å¼¹å‡ºäº¤äº’å¼é…ç½®ç•Œé¢
export DEBIAN_FRONTEND=noninteractive

apt install snort
```

## å®éªŒè¿‡ç¨‹




### å®éªŒä¸€ï¼šé…ç½®snortä¸ºå—…æ¢æ¨¡å¼

```bash
# æ˜¾ç¤ºIP/TCP/UDP/ICMPå¤´
snort -v
```


![](./img/snort-v.PNG)


```bash
# æ˜¾ç¤ºåº”ç”¨å±‚æ•°æ®
snort -vd
```

ä¸€äº›UDPå¤´

![](./img/snort-vd-udp.PNG)

ä»¥åŠä¸€äº›ICMPå¤´

![](./img/snort-vd-icmp.PNG)

```bash
# æ˜¾ç¤ºæ•°æ®é“¾è·¯å±‚æŠ¥æ–‡å¤´
snort -vde
```


![](./img/snort-vde.PNG)

```bash
# -b å‚æ•°è¡¨ç¤ºæŠ¥æ–‡å­˜å‚¨æ ¼å¼ä¸º tcpdump æ ¼å¼æ–‡ä»¶
# -q é™é»˜æ“ä½œï¼Œä¸æ˜¾ç¤ºç‰ˆæœ¬æ¬¢è¿ä¿¡æ¯å’Œåˆå§‹åŒ–ä¿¡æ¯
snort -q -v -b -i eth0 "port not 22"

# ä½¿ç”¨ CTRL-C é€€å‡ºå—…æ¢æ¨¡å¼
# å—…æ¢åˆ°çš„æ•°æ®åŒ…ä¼šä¿å­˜åœ¨ /var/log/snort/snort.log.<epoch timestamp>
# å…¶ä¸­<epoch timestamp>ä¸ºæŠ“åŒ…å¼€å§‹æ—¶é—´çš„UNIX Epoch Timeæ ¼å¼ä¸²
# å¯ä»¥é€šè¿‡å‘½ä»¤ date -d @<epoch timestamp> è½¬æ¢æ—¶é—´ä¸ºäººç±»å¯è¯»æ ¼å¼
# exampel: date -d @1511870195 è½¬æ¢æ—¶é—´ä¸ºäººç±»å¯è¯»æ ¼å¼
# ä¸Šè¿°å‘½ä»¤ç”¨tsharkç­‰ä»·å®ç°å¦‚ä¸‹ï¼š
tshark -i eth0 -f "port not 22" -w 1_tshark.pcap
```

æŸ¥çœ‹å—…æ¢ç»“æœ

![](./img/tshark.PNG)


### å®éªŒäºŒï¼šé…ç½®å¹¶å¯ç”¨snortå†…ç½®è§„åˆ™

```bash
# /etc/snort/snort.conf ä¸­çš„ HOME_NET å’Œ EXTERNAL_NET éœ€è¦æ­£ç¡®å®šä¹‰
# ä¾‹å¦‚ï¼Œå­¦ä¹ å®éªŒç›®çš„ï¼Œå¯ä»¥å°†ä¸Šè¿°ä¸¤ä¸ªå˜é‡å€¼å‡è®¾ç½®ä¸º any
```

![](./img/HOME-NET.PNG)

```bash

snort -q -A console -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/

```

![](./img/å†…ç½®è§„åˆ™.PNG)

### å®éªŒä¸‰ï¼šè‡ªå®šä¹‰snortè§„åˆ™


```
# æ–°å»ºè‡ªå®šä¹‰ snort è§„åˆ™æ–‡ä»¶
cat << EOF > /etc/snort/rules/cnss.rules
alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Access Violation has been detected on /etc/passwd ";flags: A+; content:"/etc/passwd"; nocase;sid:1000001; rev:1;)
alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Possible too many connections toward my http server"; threshold:type threshold, track by_src, count 100, seconds 2; classtype:attempted-dos; sid:1000002; rev:1;)
EOF
```

![](./img/cnssrules.PNG)

**PS:è§„åˆ™è§£æ**

>alert tcp \$EXTERNAL_NET any -> \$HTTP_SERVERS 80 (msg:"Possible too many connections toward my http server"; threshold:type threshold, track by_src, count 100, seconds 2; classtype:attempted-dos; sid:1000002; rev:1;)

å‚è€ƒæ•™æä¸­çš„å›¾ç‰‡



![](./img/å‚è€ƒ.png)



å‘Šè­¦è§„åˆ™ï¼Œä»æºIPä¸º \$EXTERNAL_NETä»»æ„ç«¯å£å‘é€tcpåŒ…åˆ°ç›®æ ‡IPä¸º\$HTTP_SERVERSçš„80ç«¯å£

å‘é€ä¿¡æ¯ä¸º`Possible too many connections toward my http server`

Thresholdé‡‡ç”¨é˜ˆå€¼æ³•ï¼Œæ¯2säº§ç”Ÿ100æ¬¡è­¦å‘Š

classtypeï¼Œè§„åˆ™ç±»åˆ«è¡¨ç¤ºï¼ŒæŠŠå‘Šè­¦åˆ’åˆ†ä¸ºdosæ”»å‡»

sidï¼Œsnortè§„åˆ™idï¼›revï¼Œè§„åˆ™ç‰ˆæœ¬å·



```
# æ·»åŠ é…ç½®ä»£ç åˆ° /etc/snort/snort.conf
include $RULE_PATH/cnss.rules
```

![](./img/æ·»åŠ rulesè§„åˆ™.PNG)

```
snort -q -A fast -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/
```


![](./img/possible-too-many.PNG)

### å®éªŒå››ï¼šå’Œé˜²ç«å¢™è”åŠ¨


```

#è·å–guardianå‹ç¼©åŒ…
wget https://c4pr1c3.github.io/cuc-ns/chap0x09/attach/guardian.tar.gz

#è§£å‹ç¼© Guardian-1.7.tar.gz
tar zxf guardian.tar.gz

#å®‰è£… Guardian çš„ä¾èµ– lib
apt install libperl4-corelibs-perl

#åœ¨kali-victimä¸­å¼€å¯ snort
snort -q -A fast -b -i eth0 -c /etc/snort/snort.conf -l /var/log/snort/

#ç¼–è¾‘ guardian.conf å¹¶ä¿å­˜
#ä¿®æ”¹å†…å®¹
HostIpAddr      172.16.111.38
Interface       eth0
```


![](./img/VM-1é…ç½®.PNG)

```
#å¯åŠ¨ guardian.pl
perl guardian.pl -c guardian.conf
```
![](./img/å¯åŠ¨perl.PNG)


ç”¨attackerè¿›è¡Œnmapæ‰«æ

![](./img/nmapæ‰«æ.PNG)

æŸ¥çœ‹æ‰«æç»“æœ

![](./img/guardiançŠ¶æ€.PNG)




æŸ¥çœ‹iptablesï¼Œguardian.conf ä¸­é»˜è®¤çš„æ¥æºIPè¢«å±è”½æ—¶é—´æ˜¯ 60 ç§’ï¼ˆå±è”½æœŸé—´å¦‚æœé»‘åå•ä¸Šçš„æ¥æºIPå†æ¬¡è§¦å‘snortæŠ¥è­¦æ¶ˆæ¯ï¼Œåˆ™å±è”½æ—¶é—´ä¼šç»§ç»­ç´¯åŠ 60ç§’ï¼‰



![](./img/iptables.PNG)

## å®éªŒæ€è€ƒé¢˜

**1.IDSä¸é˜²ç«å¢™çš„è”åŠ¨é˜²å¾¡æ–¹å¼ç›¸æ¯”IPSæ–¹å¼é˜²å¾¡å­˜åœ¨å“ªäº›ç¼ºé™·ï¼Ÿæ˜¯å¦å­˜åœ¨ç›¸æ¯”è¾ƒè€Œè¨€çš„ä¼˜åŠ¿ï¼Ÿ**

IDS: å…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼Œåˆ†æå’Œç›‘è§†ç½‘ç»œæµé‡ï¼Œå°†å½“å‰çš„ç½‘ç»œæ´»åŠ¨ä¸å·²çŸ¥çš„å¨èƒæ•°æ®åº“è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ£€æµ‹å…¥ä¾µè¡Œä¸ºï¼Œæ£€æµ‹ä»£è¡¨ç€ä¸ä¼šä¸»åŠ¨ä¿®æ”¹æ•°æ®åŒ…

IPSï¼šå…¥ä¾µé˜²å¾¡ç³»ç»Ÿï¼Œä¸é˜²ç«å¢™ä½äºåŒä¸€ç½‘ç»œåŒºåŸŸï¼Œé˜²å¾¡æ„å‘³ç€ä¼šæ ¹æ®åŒ…çš„å†…å®¹ä¸»åŠ¨é˜»æ­¢åŒ…çš„ä¼ é€’

**ç¼ºé™·**ï¼šIDSå³ä½¿æ£€æµ‹åˆ°äº†å…¥ä¾µè¡Œä¸ºï¼Œä¹Ÿæ— æ³•ä¸»åŠ¨æ‹¦æˆªé˜²å¾¡

**ä¼˜åŠ¿**ï¼šå½“IDSè¯¯æŠ¥æ—¶ï¼Œåªä¼šå¼•èµ·è­¦æŠ¥ï¼›å½“IPSè¯¯æŠ¥æ—¶ï¼Œä¼šå¼•èµ·é‡è¦æ•°æ®åŒ…çš„ä¸¢å¤±

2.ä½¿ç”¨ suricata ä»£æ›¿ Snort ï¼Œé‡å¤æœ¬å®éªŒ

3.é…ç½® suricata ä¸º IPS æ¨¡å¼ï¼Œé‡å¤ `å®éªŒå››`

**è¯´æ˜ğŸ˜€ï¼š**

kali-victimçš„IPåœ°å€ç”±172.16.111.38å˜ä¸º172.16.111.39ï¼Œå…¶ä»–IPåœ°å€å‡ä¸å˜

**å®éªŒä¸€ï¼šé…ç½® suricata ä¸ºå—…æ¢æ¨¡å¼**

```bash
#æ›´æ–°
apt-get update

#å®‰è£…ä¾èµ–
apt-get install libpcre3-dbg libpcre3-dev autoconf automake libtool libpcap-dev libnet1-dev libyaml-dev zlib1g-dev libcap-ng-dev libmagic-dev libjansson-dev libjansson4
apt-get install libnetfilter-queue-dev libnetfilter-queue1 libnfnetlink-dev

#è·å–å‹ç¼©åŒ…
 wget http://www.openinfosecfoundation.org/download/suricata-5.0.0.tar.gz

#è§£å‹
tar xzf suricata-5.0.0.tar.gz

#æŸ¥çœ‹å½“å‰ç›®å½•æ–‡ä»¶å¤¹
cd suricata-5.0.0/
ls
```

![](./img/5.0.0.PNG)

```bash
#é…ç½®å¹¶å®‰è£…
./configure --enable-nfqueue --prefix=/usr --sysconfdir=/etc --localstatedir=/var
make
make install
make install-rules

#æŸ¥çœ‹ç‰ˆæœ¬
suricata -V
```

![](./img/æŸ¥çœ‹ç‰ˆæœ¬.PNG)

```bash
#å¼€å¯ç›‘å¬eth0
suricata -c /etc/suricata/suricata.yaml -i eth0

#æŸ¥çœ‹æ—¥å¿—
#æ—¥å¿—ä¿å­˜åœ¨/var/log/suricata/ç›®å½•ä¸‹
cd /var/log/suricata/
ls -l
#fast.logæ˜¯æŠ¥è­¦æ—¥å¿—æ–‡ä»¶
```

![](./img/å®Œæˆ1.PNG)

**å®éªŒäºŒï¼šé…ç½®å¹¶å¯ç”¨suricataå†…ç½®è§„åˆ™**

æŸ¥çœ‹`/etc/suricata/suricata.yaml`æ–‡ä»¶ä¸­`HOME_NET`å’Œ`EXTERNAL_NET`

![](./img/S-HOME-NET.PNG)

```bash
#suricataçš„å†…ç½®è§„åˆ™åœ¨/var/lib/suricata/rules/ä¸‹
cd /var/lib/suricata/rules/
ls -l
```

![](./img/rules.PNG)

```bash
#åœ¨kali-victimä¸»æœºä¸Šå¼€å¯ç›‘å¬
suricata -c /etc/suricata/suricata.yaml -i eth0

#åœ¨kali-attackerä¸»æœºä¸Šæ‰«æ
nmap 172.16.111.39 -A -T4 -n -vv
```

æŸ¥çœ‹æ‰«æç»“æœ

![](./img/è‡ªå®šä¹‰è§„åˆ™.PNG)



**å®éªŒä¸‰ï¼šè‡ªå®šä¹‰suricataè§„åˆ™**

```
#æ–°å»ºè‡ªå®šä¹‰suricataè§„åˆ™æ–‡ä»¶
vim /var/lib/suricata/rules/test.rules
#ä¿®æ”¹å†…å®¹å¦‚ä¸‹
alert tcp any any -> any 80 (msg:"Possible too many connections toward my http server"; threshold:type threshold, track by_src, count 100, seconds 2; classtype:attempted-dos; sid:1000002; rev:1;)

```

![](./img/test-rule.PNG)

```bash
#æ·»åŠ é…ç½®ä»£ç åˆ° /etc/suricata/suricata.yaml
vim /etc/suricata/suricata.yaml

#ä¿®æ”¹å†…å®¹
rule-files:
	- test.rules
	
suricata -v -c /etc/suricata/suricata.yaml -i eth0	
```



![](./img/s-è‡ªå®šä¹‰.PNG)



**å®éªŒå››ï¼šå’Œé˜²ç«å¢™è”åŠ¨**ï¼ˆæœªå®Œæˆï¼‰

```bash
#åœ¨kali-victimä¸­å¼€å¯suricata
suricata -v -c /etc/suricata/suricata.yaml -i eth0	

#ç¼–è¾‘ guardian.conf å¹¶ä¿å­˜
#ä¿®æ”¹å†…å®¹
HostIpAddr      172.16.111.39
Interface       eth0

#å¯åŠ¨ guardian.pl
perl guardian.pl -c guardian.conf

#åœ¨kali-attackerä¸Šæ‰§è¡Œå‘½ä»¤
ab -n 1000  http://172.16.111.39/test
```



![](./img/æ²¡æœ‰æ˜¾ç¤º.PNG)



åœ¨é€šè¿‡æ”»å‡»è€…è¿›è¡Œå‹åŠ›æµ‹è¯•æ—¶ï¼Œguardianæ²¡æœ‰ä»»ä½•ååº”ï¼Œé€šè¿‡æŸ¥çœ‹iptablesï¼Œæ”»å‡»è€…ä¹Ÿå¹¶æ²¡æœ‰è¢«æ·»åŠ åˆ°é»‘åå•ä¸­ï¼Œæœªè§£å†³T T



**é…ç½® Suricata ä¸º IPS æ¨¡å¼**



```bash
#é…ç½®iptables
sudo iptables -I INPUT -j NFQUEUE
sudo iptables -I OUTPUT -j NFQUEUE

#æ·»åŠ è§„åˆ™åˆ°/var/lib/suricata/rules/suricata.rules
alert tcp any any -> any any (msg:"Test ab"; threshold:type threshold, track by_src, count 100, seconds 2; classtype:attempted-dos; sid:1000002; rev:1;)


#å¯ç”¨ NFQ æ¨¡å¼
sudo suricata -v -c /etc/suricata/suricata.yaml -q 0
```



![](./img/IPSæ¨¡å¼.PNG)



```bash
#æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
sudo iptables -vnL
```



![](./img/æŸ¥çœ‹iptables.PNG)





## é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ³•

1.kaliæ— æ³•å®‰è£…snort

è§£å†³ï¼šä¿®æ”¹/etc/apt/sources.listä¸º
```
deb http://http.kali.org/kali kali-rolling main contrib non-free
# For source package access, uncomment the following line
# deb-src http://http.kali.org/kali kali-rolling main contrib non-free
deb http://http.kali.org/kali sana main non-free contrib
deb http://security.kali.org/kali-security sana/updates main contrib non-free
# For source package access, uncomment the following line
# deb-src http://http.kali.org/kali sana main non-free contrib
# deb-src http://security.kali.org/kali-security sana/updates main contrib non-free
deb http://old.kali.org/kali moto main non-free contrib
# For source package access, uncomment the following line
# deb-src http://old.kali.org/kali moto main non-free contrib
```

2.tsharkæŠ¥é”™



![](./img/tsharkæŠ¥é”™.PNG)

è§£å†³ï¼šæ›´æ¢åˆ°äº†å®¶ç›®å½•ä¸‹ï¼Œå†æ‰§è¡Œå³å¯

3.æ”»å‡»è€…ä¸»æœºåœ¨å¯¹victimè¿›è¡Œå‹åŠ›æµ‹è¯•`ab -n 200 http://172.16.111.38/`æ—¶ï¼Œæ— æ³•å»ºç«‹è¿æ¥ï¼Œæ˜¾ç¤º

`apr_socket_recv: connection refused (111)`

![](./img/æ— æ³•è¿æ¥.PNG)

è§£å†³ï¼šç½‘ç»œæ•…éšœå±‚å±‚æ’æŸ¥ï¼Œattackerå’Œvictimä¹‹é—´å¯ä»¥ç›¸äº’pingé€šï¼Œä½†æ˜¯æ‰§è¡Œ`curl http://172.16.111.38/`æ—¶æŠ¥é”™`curl: (7) Failed to connect to 172.16.111.38 port 80: Connection refused`

ç”¨nmapæ‰«æå‘ç°æ˜¯victimçš„80ç«¯å£æ²¡å¼€

![](./img/close.PNG)

é€šè¿‡apacheå°†80ç«¯å£æ‰“å¼€å°±å¥½å•¦



4.ä½¿ç”¨suricataå’Œé˜²ç«å¢™è”åŠ¨ï¼ˆå®éªŒå››ï¼‰æœªè§£å†³ï¼Œè¹²ä¸€ä¸ªè§£å†³æ–¹æ³•





## å‚è€ƒæ–‡çŒ®

[2018-NS-Public-jckling](https://github.com/CUCCS/2018-NS-Public-jckling/blob/master/ns-0x09/IDS%26IPSå®éªŒæŠ¥å‘Š.md)

[2019-NS-Public-chencwx](https://github.com/CUCCS/2019-NS-Public-chencwx/blob/ns_chap0x09/ns_chapter9/%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B.md)

[è¯¾æœ¬ç¬¬ä¹ç« ](https://c4pr1c3.github.io/cuc-ns/chap0x09/exp.html)

[how-to-solve-kali-linux-apt-get-install-e-unable-to-locate-package-checkinstall](https://ourcodeworld.com/articles/read/961/how-to-solve-kali-linux-apt-get-install-e-unable-to-locate-package-checkinstall)


[ab testing - apr_socket_recv: Connection refused (111)](https://www.apachelounge.com/viewtopic.php?t=6021)

[install-suricata](https://www.unixmen.com/install-suricata-ids-on-ubuntu-16-04/)

[Suricata User Guide Release 5.0.0-dev](https://suricata.readthedocs.io/_/downloads/en/suricata-5.0.0-beta1/pdf/)

[Suricata rules](https://suricata.readthedocs.io/en/suricata-5.0.0/rules/intro.html)

[Suricataè§„åˆ™ä»‹ç»](https://zhuanlan.zhihu.com/p/36340468)



